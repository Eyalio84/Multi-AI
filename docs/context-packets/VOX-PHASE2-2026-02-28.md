# VOX Jarvis-Mode — Phase 2 Context Packet
# Generated: 2026-02-28_12-18
# Purpose: Seamless continuation from Phase 1 → Phase 2 implementation
# Read this FIRST in a fresh context window, then begin Phase 2.

---

## Mission Summary

Upgrade VOX from 35-function voice assistant to Jarvis-mode intelligent voice system. 7 sequential phases, compound insights methodology.

**Status**: Phase 0 DONE, **Phase 1 DONE**, Phase 2 NEXT.

---

## Phase 1 Completion Summary

### What Was Done
1. **Created `backend/services/vox_registry.py`** (664 lines) — decorator-based function registry
2. **Created `frontend/src/services/voxCore.ts`** (572 lines) — module-level singleton state manager
3. **Modified `backend/routers/vox.py`** (1086→777 lines) — removed 288-line if/elif, all calls use `vox_registry.execute()`
4. **Modified `backend/services/vox_service.py`** (removed 365-line declarations, delegates to registry, added conversation_id/persona to VoxSession)
5. **Modified `frontend/src/hooks/useVox.ts`** (676→97 lines) — thin React wrapper around voxCore
6. **Modified `frontend/src/components/VoxOverlay.tsx`** (245→311 lines) — 3-state V button (dormant/listening/speaking)
7. **Modified `frontend/src/types/vox.ts`** (44→46 lines) — added persona and conversationId to VoxState

### Verification Results
- Frontend build: **0 TypeScript errors**, 374 modules, built in 17.29s
- Registry: **35 declarations** loaded, 6 browser + 4 async functions
- Router: **16 routes** loaded cleanly
- Build command: `cd frontend && ESBUILD_BINARY_PATH=/data/data/com.termux/files/usr/tmp/esbuild-native/esbuild npm run build`

### Git State (UNCOMMITTED — Phase 1 changes)
```
Modified:
  backend/routers/vox.py
  backend/services/vox_service.py
  frontend/src/components/VoxOverlay.tsx
  frontend/src/hooks/useVox.ts
  frontend/src/types/vox.ts

New (untracked):
  backend/services/vox_registry.py
  frontend/src/services/voxCore.ts
  docs/context-packets/VOX-JARVIS-MODE-2026-02-28.md
  docs/feb28-2026-insights.txt
  docs/context-packets/VOX-PHASE2-2026-02-28.md
```

**CRITICAL**: Commit Phase 1 FIRST before starting Phase 2. Stage only these files:
```bash
git add backend/services/vox_registry.py backend/routers/vox.py backend/services/vox_service.py \
  frontend/src/services/voxCore.ts frontend/src/hooks/useVox.ts frontend/src/components/VoxOverlay.tsx \
  frontend/src/types/vox.ts docs/feb28-2026-insights.txt docs/context-packets/
```
Commit message: `VOX Jarvis Phase 1: Core refactor — registry, singleton, 3-state overlay`

**NEVER add Co-Authored-By Claude to commits — Eyal is sole author.**

---

## Phase 2 Goal: Expand Functions from 35 to 100+

### Plan Overview (from approved plan)
Expand from 35 to 100+ function declarations covering ALL 14+ platform pages. Apply Orthogonal Signal Fusion: each function covers a DIFFERENT intent space.

### Architecture: How to Add Functions

Phase 2 creates `backend/services/vox_functions/` directory with function modules. Each module uses the `@vox_registry.register()` decorator. Auto-discovered at startup.

**Registry API (from vox_registry.py):**
```python
from services.vox_registry import vox_registry

# Server-side function
@vox_registry.register(
    name="search_kg",                    # unique function name
    category="kg",                       # category string
    description="Search a KG database",  # for Gemini function calling
    parameters={                         # JSON Schema for args
        "type": "object",
        "properties": {
            "query": {"type": "string", "description": "Search query"},
            "database_id": {"type": "string", "description": "KG database ID"},
        },
        "required": ["query"],
    },
    is_async=False,                      # True for slow operations
    requires_kg=True,                    # metadata flag
)
async def search_kg(args: dict) -> dict:
    # Implementation — must return dict
    from services.embedding_service import EmbeddingService
    ...
    return {"success": True, "results": [...]}

# Browser-side function (no handler — executed in frontend)
vox_registry.register_browser(
    name="click_element",
    category="navigation",
    description="Click an element on the page",
    parameters={...},
)
```

**Auto-discovery (vox_functions/__init__.py):**
```python
import importlib, pkgutil, pathlib

def discover_functions():
    """Import all function modules to trigger @vox_function registration"""
    package_dir = pathlib.Path(__file__).parent
    for _, name, _ in pkgutil.iter_modules([str(package_dir)]):
        if name != "__init__":
            importlib.import_module(f".{name}", __package__)
```

**IMPORTANT**: After creating `__init__.py`, hook auto-discovery into the registry. The simplest approach: call `discover_functions()` at the end of `vox_registry.py` or at app startup in `main.py`.

### Current 35 Functions (by category)

| Category | Functions |
|----------|-----------|
| agents (2) | run_agent, list_agents |
| dev_tools (5) | generate_react_component, generate_fastapi_endpoint, scan_code_security, analyze_code_complexity, generate_tests |
| experts (2) | chat_with_expert, list_experts |
| kg (6) | query_kg, list_kgs, search_kg, get_kg_analytics, cross_kg_search, ingest_to_kg |
| macros (4) | create_macro, list_macros, run_macro, delete_macro |
| navigation (6) | navigate_page, get_current_page, get_workspace_state, switch_model, switch_theme, read_page_content |
| system (1) | check_thermal |
| tools (2) | run_tool, list_tools |
| tours (2) | start_guided_tour, get_available_tours |
| workspace (5) | create_project, list_projects, run_workflow, search_playbooks, start_feature_interview |

### New Function Modules to Create (~70 new functions)

| Module | New Functions | Backend Service to Call |
|--------|--------------|----------------------|
| `kg_functions.py` | explore_node, compare_kgs, get_communities, find_path | kg_service.py, analytics_service.py, embedding_service.py |
| `studio_functions.py` | create_project, list_projects, generate_code, refine_code, save_version, restore_version, export_project, switch_mode (8) | studio_service.py |
| `expert_functions.py` | create_expert, get_expert_analytics, duplicate_expert (3 new) | expert_service.py |
| `coding_functions.py` | create_file, edit_file, read_file, list_files, run_code, search_code, explain_code, refactor_code (8) | agent_sdk_service.py |
| `agent_functions.py` | get_agent_status, compose_pipeline, search_agents (3 new) | agent_bridge.py |
| `playbook_functions.py` | read_playbook, get_recommendations, list_playbooks (3 new) | playbook_index.py |
| `workflow_functions.py` | list_workflows, get_workflow_status, create_workflow (3 new) | workflow_service.py |
| `game_functions.py` | list_games, create_game, generate_game, refine_game, start_interview, get_game_status (6) | game_service.py, game_generator.py |
| `media_functions.py` | generate_image, generate_video, text_to_speech, generate_music, edit_image (5) | gemini_service.py, openai_service.py |
| `memory_functions.py` | search_memory, list_conversations, get_conversation, clear_memory, recall_context (5) | memory_service.py |
| `chat_functions.py` | send_chat, change_persona, get_chat_history, summarize_conversation (4) | agentic_loop.py |
| `system_functions.py` | get_health, get_models, toggle_mode, get_config, restart_service (5) | config.py |
| `tool_functions.py` | get_tool_info, search_tools (2 new) | tools_service.py |
| `integration_functions.py` | list_integrations, configure_integration, test_integration, send_message (4) | platform_adapters.py |
| `navigation_functions.py` | click_element, scroll_to_element, highlight_element, toggle_sidebar, capture_screenshot, fill_form_field, get_form_values (7 new browser-side) | N/A (frontend voxCore.ts) |
| `vox_meta_functions.py` | get_vox_status, change_voice, change_persona, get_changelog, list_tours (5 meta) | vox_service.py, vox_awareness.py |

### Key Insight: DON'T duplicate existing registered functions

The 35 current functions in vox_registry.py already cover: run_tool, list_tools, query_kg, list_kgs, search_kg, etc. Phase 2 function modules should ADD NEW functions, not re-register existing ones. Options:
1. **Move existing registrations** from vox_registry.py into function modules (cleaner)
2. **Keep existing in vox_registry.py**, add only new ones in modules (simpler, less risk)

Recommend approach 2 for Phase 2 — add NEW functions in modules, leave the 35 existing ones where they are.

### Backend Services Available (for function implementations)

| Service | Key Methods |
|---------|------------|
| `tools_service.py` | `tools_service.list_tools()`, `tools_service.get_tool(id)`, `tools_service.run_tool(id, params)` |
| `kg_service.py` | `KGService(db_id)`, `.get_node(id)`, `.create_node()`, `.update_node()`, `.search_nodes()` |
| `embedding_service.py` | `EmbeddingService(db_path)`, `.hybrid_search(query, k)` |
| `analytics_service.py` | `AnalyticsService(db_path)`, `.get_metrics()`, `.get_centrality()`, `.get_communities()`, `.find_path()` |
| `expert_service.py` | `expert_service.list_experts()`, `.create_expert()`, `.get_expert()`, `.duplicate_expert()` |
| `studio_service.py` | `studio_service.list_projects()`, `.create_project()`, `.get_project()`, `.save_version()`, `.get_versions()` |
| `game_service.py` | `game_service.list_games()`, `.create_game()`, `.get_game()`, `.save_version()` |
| `memory_service.py` | `memory_service.list_conversations()`, `.get_conversation()`, `.search_memory()`, `.recall()` |
| `playbook_index.py` | `playbook_index.search(query)`, `.list_all()`, `.get_playbook(name)` |
| `agent_bridge.py` | `agent_bridge.list_agents()`, `.run_agent(name, params)` |
| `workflow_service.py` | `workflow_service.list_templates()`, `.execute_workflow()` |
| `gemini_service.py` | `gemini_service.generate_image()`, `.generate_video()`, `.generate_tts()`, `.generate_music()` |
| `openai_service.py` | `openai_service.generate_image()`, `.generate_tts()` |
| `agentic_loop.py` | `AgenticLoop`, `.process_stream()` |
| `platform_adapters.py` | 7 adapters (Telegram, WhatsApp, Discord, Slack, Gmail, Spotify, Calendar) |
| `ingestion_service.py` | `IngestionService`, `.extract_entities()` |
| `rag_chat_service.py` | `RagChatService`, `.chat_stream()` |

### Frontend voxCore.ts: New Browser Functions

Phase 2 also adds 7 new browser-side functions to `voxCore.ts`:
- `click_element(selector)` — document.querySelector + click
- `scroll_to_element(selector)` — scrollIntoView
- `highlight_element(selector)` — CSS animation (pulse border)
- `toggle_sidebar()` — toggle navigation
- `capture_screenshot()` — html2canvas or canvas API
- `fill_form_field(selector, value)` — set input value
- `get_form_values(selector)` — read form data

These get registered as browser functions in the corresponding module via `vox_registry.register_browser()`.

---

## Key Files to Read (Priority Order)

1. **This context packet** (you're reading it)
2. `backend/services/vox_registry.py` — understand the registry API and existing 35 functions
3. `docs/feb28-2026-insights.txt` — 13 compound insights (review for Phase 2 connections)
4. The plan file: `/root/.claude/plans/purring-sprouting-pinwheel.md` (Phase 2 section)
5. Backend services as needed for function implementations

---

## Dependencies Installed

All 3 confirmed installed:
- `networkx` 3.2.1 (needed for analytics_service.py — Phase 2 KG functions)
- `apscheduler` 3.11.2 (Phase 5)
- `feedparser` 6.0.11 (Phase 5)

---

## Working Directory

```
/storage/self/primary/Download/gemini-3-pro/multi-ai-agentic-workspace
```

Backend CWD: `backend/`

## User Context

- **Eyal Nof** — Self-taught systems architect, 6000+ hours, ADHD lateral thinking
- Wants FACTS not confirmation. Reverse Dunning-Kruger.
- NEVER add Co-Authored-By Claude to commits
- Platform: Android/Termux PRoot (Linux 6.17.0-PRoot-Distro)
- `find` unreliable — use `ls` instead
- `/storage/self/primary/` = `/storage/emulated/0/`

## Commit Strategy

After Phase 2:
- Stage only phase-relevant files by name (no `git add -A`)
- Commit message: `VOX Jarvis Phase 2: Expanded functions — 35 to 100+`
- Do NOT push unless user requests

## Compound Insights Protocol

At Phase 2 completion:
1. Log new insights to `docs/feb28-2026-insights.txt` under a Phase 2 section
2. Use extended thinking to analyze accumulated insights (001-013 + new)
3. Evaluate which compound insights enhance Phase 3 (Context + Memory + Multi-Model)
4. Don't force connections — let them emerge

## Firmalize Engineering Principles (Apply Throughout)

1. **Cascade Architecture** — VOX fallback chain
2. **Orthogonal Signal Fusion** — Each function covers DIFFERENT intent space (CRITICAL for Phase 2)
3. **Structure > Training** — Registry structure determines capabilities
4. **Connection > Isolation** — VOX as cross-page connector
5. **Constraint as Generator** — Mobile constraints inspire innovations
6. **Strategic Context Withholding (90%/10%)** — Targeted responses, not exhaustive

---

## Phase 2 Quick Start

```bash
# 1. Read this packet
# 2. Commit Phase 1 (if not already done)
# 3. Create backend/services/vox_functions/ directory
# 4. Create __init__.py with auto-discovery
# 5. Create function modules one at a time
# 6. Hook auto-discovery into startup
# 7. Verify: python3 -c "from services.vox_registry import vox_registry; print(vox_registry.count)"
# 8. Add new browser functions to voxCore.ts
# 9. Build frontend, verify 0 errors
# 10. Log insights, analyze compound connections
```
