# Session Context Packet - 2026-02-27_04-56

## Session Summary
- Date: 2026-02-27
- Session focus: SDK Integration (Steps 1-4) + Chat Page SDK UI design
- Status: Backend DONE and committed (v2.4.0). Frontend design APPROVED, ready for implementation.

## What Was Done This Session

### Backend: SDK Integration (Steps 1-4) — COMPLETED, COMMITTED
1. **Installed `claude-agent-sdk` v0.1.44** (`pip install --break-system-packages claude-agent-sdk`)
2. **Expanded model catalog**: 9 → 23 models (20 Gemini + 3 Claude) with `category` field
3. **Created Claude Agent SDK service** (`backend/services/agent_sdk_service.py`)
4. **Created agent router** (`backend/routers/agent.py`) — 3 endpoints
5. **Added media generation** to `gemini_service.py`: `generate_image`, `generate_tts`, `generate_music`, fixed `generate_video`
6. **Added media endpoints** to `media.py`: 4 new POST endpoints
7. **Updated model_router.py**: audio/music/agent task routing
8. **Verified end-to-end**: backend starts clean, 23 models in catalog, routing works

**Commit**: `64b811e` — `v2.4.0: Add Claude Agent SDK, 23-model catalog, media generation`

### Frontend: Chat Page SDK UI — DESIGN APPROVED, NOT YET IMPLEMENTED

## Approved Design: Chat Page SDK Integration

### 1. Model Selector Update
- **Current**: Hardcoded provider toggle (Gemini/Claude) + 3 models each flat dropdown
- **New**: Single grouped dropdown fetched from `/api/models`
- Groups: Text (10), Image (3), Video (3), Audio (3), Agent (2), Embedding (1, dimmed)
- Each option: model name + provider badge (G/C) + use_case subtitle
- Selecting non-text model → placeholder suggests relevant slash command
- Provider toggle becomes filter: "All", "Gemini", "Claude"

### 2. Slash Commands (5 commands)
Parsed in `handleSubmit` before `sendMessage()`:

| Command | Backend Call | Response |
|---------|-------------|----------|
| `/image <prompt>` | `POST /api/media/image/generate` | Inline `<img>` |
| `/tts <text>` | `POST /api/media/tts/generate` | Inline `<audio>` player |
| `/video <prompt>` | `POST /api/media/video/generate` | Status + operation name |
| `/agent <prompt>` | `POST /api/agent/run` (SSE) | Streamed text + tool_use |
| `/help` | Local only | System message listing commands |

Parsing: `const [cmd, ...rest] = prompt.slice(1).split(' '); const arg = rest.join(' ')`

### 3. New Message Renderers
- **Image**: Already handled via `part.imageUrl` in AssistantMessage
- **Audio**: New `part.audioUrl` → `<audio controls>`. Add `audioUrl?: string` to MessagePart
- **Agent**: Reuses existing SSE + tool_use rendering. No new renderer needed.

### 4. Files to Change (6 files, 0 new)

| File | Change |
|------|--------|
| `frontend/src/types/chat.ts` | Add `audioUrl` to MessagePart |
| `frontend/src/components/chat/ModelSelector.tsx` | Grouped dropdown from API, provider filter |
| `frontend/src/components/chat/AssistantMessage.tsx` | Add audio player renderer |
| `frontend/src/hooks/useChat.ts` | Add slash command parsing + handlers |
| `frontend/src/services/apiService.ts` | Add `generateImage`, `generateTTS`, `generateVideo`, `streamAgent` |
| `frontend/src/context/AppContext.tsx` | Fetch models from API instead of hardcoded list |

## Architecture Reference (from exploration)

### Chat Page Component Tree
```
ChatPage.tsx → ChatPanel.tsx (defaultMode="chat")
  ├── Header: ModelSelector + injection badges
  ├── Messages: Hero (empty) or MessageItem list
  │   ├── UserMessage.tsx
  │   ├── AssistantMessage.tsx (text, images, tool calls, grounding, thinking)
  │   └── ToolMessage.tsx
  └── Footer: text input + send button
```

### Key Integration Points
- **Slash command intercept**: `ChatPanel.tsx:handleSubmit` (line ~43-48) — parse before `sendMessage()`
- **SSE streaming**: `useChat.ts:processSSEStream()` (line ~76-162) — handles token/tool_call/grounding/done events
- **Model state**: `AppContext.tsx` — `activeProvider`, `activeModel`, `thinkingEnabled`, `thinkingBudget`
- **API calls**: `apiService.ts` — `streamChat()`, `streamCoding()` using fetch + ReadableStream

### Message Format
```typescript
interface Message {
  id: string;
  author: 'user' | 'assistant' | 'system' | 'tool';
  parts: MessagePart[];
  provider?: 'gemini' | 'claude';
  toolCall?: { name: string; args: any };
  thinkingContent?: string;
}

interface MessagePart {
  text?: string;
  imageUrl?: string;
  videoUrl?: string;
  audioUrl?: string;  // NEW — to be added
}
```

### SSE Event Types (existing)
`conversation_start`, `injection_meta`, `token`, `thinking_start`, `thinking`, `tool_call`, `tool_call_start`, `tool_call_delta`, `grounding`, `error`, `done`

## New Backend Endpoints (from this session)

| Method | Path | Purpose |
|--------|------|---------|
| POST | /api/agent/run | SSE streaming agent task |
| GET | /api/agent/sessions | List agent sessions |
| GET | /api/agent/sessions/{id} | Session status |
| POST | /api/media/image/generate | Text-to-image (Nano Banana/Imagen 4) |
| POST | /api/media/video/generate | Veo 3.1 video generation |
| POST | /api/media/tts/generate | Text-to-speech |
| POST | /api/media/music/generate | Lyria music (SKIPPED for now) |

## Model Catalog (23 models)

### By Category
- **text (10)**: gemini-3-pro-preview, gemini-3.1-pro-preview, gemini-3.1-pro-preview-customtools, gemini-3-flash-preview, gemini-2.5-flash, gemini-2.5-pro, gemini-2.5-flash-lite, claude-opus-4-6, claude-sonnet-4-6, claude-haiku-4-5-20251001
- **image (3)**: gemini-2.5-flash-image, gemini-3-pro-image-preview, imagen-4.0-generate-preview-05-20
- **video (3)**: veo-2.0-generate-001, veo-3.1-generate-preview, veo-3.1-fast-generate-preview
- **audio (3)**: gemini-2.5-flash-native-audio-preview, gemini-2.5-flash-preview-tts, gemini-2.5-pro-preview-tts
- **music (1)**: lyria-realtime-exp
- **embedding (1)**: gemini-embedding-001
- **agent (2)**: gemini-2.5-computer-use-preview, deep-research-pro-preview

## Key Decisions Made
1. **Grouped dropdown** for model picker (not tabs, not text-only)
2. **Slash commands** in chat input (not a separate panel)
3. **Skip Lyria/music** for initial implementation — experimental
4. **6 files changed, 0 new** — minimal footprint within existing architecture
5. **Provider toggle becomes filter** ("All"/"Gemini"/"Claude") rather than hard switch
6. **`apt install python3-<pkg>`** available as alternative to pip on Termux

## Quick Resume Instructions

1. **Read this context packet** to understand what was done and what's next
2. **The backend is done** — `v2.4.0` committed at `64b811e`. Don't touch backend files.
3. **Next step: Write implementation plan** then implement the 6 frontend file changes described in the "Approved Design" section above
4. **Use the `writing-plans` skill** to create a step-by-step implementation plan from the approved design
5. **Key files to read first**: `frontend/src/hooks/useChat.ts`, `frontend/src/components/chat/ModelSelector.tsx`, `frontend/src/components/chat/ChatPanel.tsx`, `frontend/src/services/apiService.ts`
6. **Frontend builds with**: `ESBUILD_BINARY_PATH=/data/data/com.termux/files/usr/tmp/esbuild-native/esbuild`
7. **Test manually**: Start backend on :8000, frontend on :5173+, test each slash command
