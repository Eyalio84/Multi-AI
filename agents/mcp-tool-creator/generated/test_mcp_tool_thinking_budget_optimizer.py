#!/usr/bin/env python3
"""
Test stub for MCP Tool: mcp-thinking-budget-optimizer

Tests all tool handlers with example inputs.
Generated by: NLKE MCP Tool Creator (Phase 5)
"""

import json
import subprocess
import sys


def test_list_tools():
    """Test that --list-tools works."""
    result = subprocess.run(
        ["python3", "/storage/self/primary/Download/44nlke/NLKE/agents/mcp-tool-creator/generated/mcp_tool_thinking_budget_optimizer.py", "--list-tools"],
        capture_output=True, text=True, timeout=10,
    )
    assert result.returncode == 0, f"list-tools failed: {result.stderr}"
    print("  list-tools: OK")


def test_self_test():
    """Test that --test works."""
    result = subprocess.run(
        ["python3", "/storage/self/primary/Download/44nlke/NLKE/agents/mcp-tool-creator/generated/mcp_tool_thinking_budget_optimizer.py", "--test"],
        capture_output=True, text=True, timeout=30,
    )
    assert result.returncode == 0, f"self-test failed: {result.stderr}"
    print("  self-test: OK")


def test_stdio_protocol():
    """Test MCP protocol via stdio."""
    proc = subprocess.Popen(
        ["python3", "/storage/self/primary/Download/44nlke/NLKE/agents/mcp-tool-creator/generated/mcp_tool_thinking_budget_optimizer.py", "--stdio"],
        stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
        text=True,
    )

    # Send initialize
    init_msg = json.dumps({
        "jsonrpc": "2.0", "id": 1, "method": "initialize",
        "params": {"protocolVersion": "2024-11-05", "capabilities": {}}
    })
    proc.stdin.write(init_msg + "\n")
    proc.stdin.flush()

    response = proc.stdout.readline()
    data = json.loads(response)
    assert data.get("id") == 1, f"Bad init response: {data}"
    print("  initialize: OK")

    # Send tools/list
    list_msg = json.dumps({"jsonrpc": "2.0", "id": 2, "method": "tools/list", "params": {}})
    proc.stdin.write(list_msg + "\n")
    proc.stdin.flush()

    response = proc.stdout.readline()
    data = json.loads(response)
    tools = data.get("result", {}).get("tools", [])
    assert len(tools) == 1, f"Expected 1 tools, got {len(tools)}"
    print(f"  tools/list: OK ({len(tools)} tools)")

    proc.terminate()


if __name__ == "__main__":
    print("Testing MCP Tool: mcp-thinking-budget-optimizer")
    print()
    try:
        test_list_tools()
        test_self_test()
        test_stdio_protocol()
        print()
        print("All tests passed!")
    except Exception as e:
        print(f"\nTEST FAILED: {e}")
        sys.exit(1)
